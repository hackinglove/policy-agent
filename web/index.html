<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Insight | 政策洞察系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .slide-fade-enter-active { transition: all 0.3s ease-out; }
        .slide-fade-leave-active { transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1); }
        .slide-fade-enter-from, .slide-fade-leave-to { transform: translateX(20px); opacity: 0; }
        
        /* Custom Scrollbar for Logs */
        .log-container::-webkit-scrollbar { width: 8px; }
        .log-container::-webkit-scrollbar-track { background: #1e293b; }
        .log-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6);
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

<div id="app" class="flex h-screen overflow-hidden">
    
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm">
        <div class="p-6">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent flex items-center gap-2">
                <i class="ph-fill ph-hexagon text-blue-600"></i>
                Policy Insight
            </h1>
            <p class="text-xs text-slate-400 mt-1 pl-1">智能政策采集系统 v2.0</p>
        </div>
        
        <nav class="flex-1 px-4 space-y-1">
            <template v-for="item in menuItems" :key="item.id">
                <a href="#" @click="currentView = item.id" 
                   :class="currentView === item.id ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200">
                    <i :class="['ph', item.icon, 'text-lg']"></i>
                    {{ item.label }}
                </a>
            </template>
        </nav>

        <div class="p-4 border-t border-slate-100">
            <button @click="triggerCrawl" :disabled="isCrawling" 
                class="w-full flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-800 text-white py-2.5 px-4 rounded-lg text-sm transition-all shadow-lg shadow-slate-200 disabled:opacity-70 disabled:cursor-not-allowed group">
                <i class="ph ph-arrows-clockwise group-hover:rotate-180 transition-transform duration-500" :class="{'animate-spin': isCrawling}"></i>
                {{ isCrawling ? '采集运行中...' : '立即同步数据' }}
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative flex flex-col">
        <!-- Top Bar -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-8 py-4 flex justify-between items-center z-10">
            <h2 class="text-lg font-semibold text-slate-800">{{ pageTitle }}</h2>
            <div class="flex items-center gap-4">
                <div class="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    {{ wsConnected ? '实时连接正常' : '连接断开' }}
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto bg-slate-50/50 p-6 relative">
            
            <!-- Dashboard View -->
            <transition name="slide-fade" mode="out-in">
                <div v-if="currentView === 'dashboard'" key="dashboard" class="space-y-6 max-w-6xl mx-auto">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-slate-500">政策总收录</p>
                                    <h3 class="text-3xl font-bold text-slate-800 mt-2">{{ stats.total_policies || 0 }}</h3>
                                </div>
                                <div class="p-3 bg-blue-50 text-blue-600 rounded-lg">
                                    <i class="ph-fill ph-database text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-slate-500">今日新增</p>
                                    <h3 class="text-3xl font-bold text-emerald-600 mt-2">+{{ stats.today_new || 0 }}</h3>
                                </div>
                                <div class="p-3 bg-emerald-50 text-emerald-600 rounded-lg">
                                    <i class="ph-fill ph-trend-up text-xl"></i>
                                </div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-slate-500">活跃源站</p>
                                    <h3 class="text-3xl font-bold text-indigo-600 mt-2">{{ sources.length || 0 }}</h3>
                                </div>
                                <div class="p-3 bg-indigo-50 text-indigo-600 rounded-lg">
                                    <i class="ph-fill ph-globe text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Latest Policies (Replaces Logs) -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-newspaper text-blue-500"></i> 最新收录政策
                            </h3>
                            <button @click="currentView = 'policies'" class="text-xs text-blue-600 hover:text-blue-800 font-medium">查看全部 &rarr;</button>
                        </div>
                        <div class="divide-y divide-slate-50">
                            <div v-for="policy in latestPolicies" :key="policy.url" class="px-6 py-3 hover:bg-slate-50 transition-colors flex justify-between items-center group">
                                <div class="flex-1 min-w-0 pr-4">
                                    <h4 class="text-sm font-medium text-slate-800 truncate group-hover:text-blue-600 transition-colors">
                                        <a :href="policy.url" target="_blank">{{ policy.title }}</a>
                                    </h4>
                                    <div class="flex gap-3 mt-1 text-xs text-slate-400">
                                        <span>{{ policy.source_name }}</span>
                                        <span>{{ policy.publish_date }}</span>
                                    </div>
                                </div>
                                <a :href="policy.url" target="_blank" class="p-2 text-slate-300 hover:text-blue-600"><i class="ph ph-arrow-square-out text-lg"></i></a>
                            </div>
                            <div v-if="latestPolicies.length === 0" class="p-8 text-center text-slate-400 text-sm">
                                暂无数据
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs View -->
                <div v-else-if="currentView === 'logs'" key="logs" class="max-w-6xl mx-auto h-full flex flex-col">
                    <div class="bg-slate-900 rounded-xl overflow-hidden shadow-lg border border-slate-700 flex flex-col flex-1 h-full min-h-[500px]">
                        <div class="px-4 py-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <span class="text-slate-300 text-sm font-mono flex items-center gap-2">
                                <i class="ph ph-terminal-window"></i> 系统运行日志
                            </span>
                            <div class="flex gap-3">
                                <button @click="triggerCrawl" :disabled="isCrawling" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded transition-colors disabled:opacity-50">
                                    {{ isCrawling ? '运行中...' : '启动采集' }}
                                </button>
                                <button @click="logs = []" class="text-xs text-slate-400 hover:text-white transition-colors">清空</button>
                            </div>
                        </div>
                        <div class="p-4 overflow-y-auto font-mono text-xs md:text-sm text-slate-300 space-y-1 flex-1 log-container" ref="logContainer">
                            <div v-if="logs.length === 0" class="text-slate-600 italic">等待任务启动...</div>
                            <div v-for="(log, i) in logs" :key="i" class="break-words whitespace-pre-wrap">{{ log }}</div>
                        </div>
                    </div>
                </div>
            
                <!-- Policies List View -->
                <div v-else-if="currentView === 'policies'" key="policies" class="max-w-6xl mx-auto">
                    <!-- Advanced Search Panel -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 p-5">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-1">
                                <label class="block text-xs font-medium text-slate-500 mb-1">关键词</label>
                                <div class="relative">
                                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input v-model="searchQuery" @keyup.enter="fetchPolicies(1)" 
                                        class="w-full pl-9 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" 
                                        placeholder="标题/内容...">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">来源部门</label>
                                <select v-model="searchSource" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    <option value="">全部来源</option>
                                    <option v-for="s in sources" :key="s.name" :value="s.name">{{ s.name }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">开始日期</label>
                                <input type="date" v-model="searchStartDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">结束日期</label>
                                <input type="date" v-model="searchEndDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end gap-3 pt-3 border-t border-slate-50">
                            <button @click="searchQuery='';searchSource='';searchStartDate='';searchEndDate='';fetchPolicies(1)" class="text-slate-500 hover:text-slate-700 text-sm px-4 py-2">重置</button>
                            <button @click="fetchPolicies(1)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors flex items-center gap-2">
                                <i class="ph ph-funnel"></i> 执行筛选
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">标题</th>
                                        <th class="px-6 py-3 w-32">发布日期</th>
                                        <th class="px-6 py-3 w-40">来源</th>
                                        <th class="px-6 py-3 w-20">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template v-for="policy in policies" :key="policy.url">
                                        <tr class="bg-white border-b border-slate-50 hover:bg-slate-50 transition-colors cursor-pointer group" @click="toggleExpand(policy)">
                                            <td class="px-6 py-4 font-medium text-slate-900 truncate max-w-md">
                                                <div class="group-hover:text-blue-600 flex items-center gap-2">
                                                    <i class="ph text-slate-400" :class="policy.expanded ? 'ph-caret-down' : 'ph-caret-right'"></i>
                                                    {{ policy.title }}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">{{ policy.publish_date }}</td>
                                            <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">{{ policy.source_name }}</span></td>
                                            <td class="px-6 py-4" @click.stop>
                                                <div class="flex items-center gap-2">
                                                    <a :href="policy.url" target="_blank" class="text-blue-600 hover:text-blue-800" title="访问官网"><i class="ph ph-arrow-square-out text-lg"></i></a>
                                                    <button @click="deletePolicy(policy)" class="text-slate-400 hover:text-red-500" title="删除政策">
                                                        <i class="ph ph-trash text-lg"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr v-if="policy.expanded" class="bg-slate-50 border-b border-slate-100 animate-fade-in">
                                            <td colspan="4" class="px-6 py-4">
                                                <div class="text-sm text-slate-700 space-y-3 p-2">
                                                    <div>
                                                        <span class="inline-flex items-center gap-1 font-semibold text-blue-600 mb-1">
                                                            <i class="ph ph-sparkle"></i> 智能摘要
                                                        </span>
                                                        <p class="leading-relaxed bg-white p-3 rounded border border-slate-200 text-slate-600">
                                                            {{ policy.summary || '暂无摘要内容。' }}
                                                        </p>
                                                    </div>
                                                    <div class="flex items-center gap-6 text-xs text-slate-400 font-mono pt-2 border-t border-slate-200">
                                                        <span><i class="ph ph-clock"></i> 收录时间: {{ policy.crawled_at }}</span>
                                                        <span><i class="ph ph-link"></i> 原始链接: {{ policy.url }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr v-if="policies.length === 0">
                                        <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                            <i class="ph ph-tray text-3xl mb-2"></i>
                                            <p>暂无数据</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex items-center justify-between" v-if="totalItems > 0">
                            <span class="text-sm text-slate-500">
                                第 {{ currentPage }} / {{ totalPages }} 页 (共 {{ totalItems }} 条)
                            </span>
                            <div class="flex gap-2">
                                <button 
                                    @click="changePage(currentPage - 1)" 
                                    :disabled="currentPage === 1"
                                    class="px-3 py-1 text-sm bg-white border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-slate-600 flex items-center gap-1">
                                    <i class="ph ph-caret-left"></i> 上一页
                                </button>
                                <button 
                                    @click="changePage(currentPage + 1)" 
                                    :disabled="currentPage === totalPages"
                                    class="px-3 py-1 text-sm bg-white border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-slate-600 flex items-center gap-1">
                                    下一页 <i class="ph ph-caret-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sources Manager View -->
                <div v-else-if="currentView === 'sources'" key="sources" class="max-w-4xl mx-auto space-y-6">
                    <!-- Add Source Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="ph ph-magic-wand text-purple-500"></i> 添加新数据源
                        </h3>
                        
                        <!-- AI Detect Section -->
                        <div class="mb-6 bg-purple-50 p-4 rounded-lg border border-purple-100">
                            <label class="block text-sm font-medium text-purple-900 mb-2">✨ AI 智能解析 (推荐)</label>
                            <div class="flex gap-2">
                                <input v-model="newSourceUrl" type="url" placeholder="输入政策列表页网址 (例如: http://example.gov.cn/list)" 
                                    class="flex-1 bg-white border border-purple-200 text-slate-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2.5">
                                <button @click="autoDetectSource" :disabled="detecting" 
                                    class="text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center gap-2 disabled:opacity-60">
                                    <i class="ph ph-sparkle" :class="{'animate-pulse': detecting}"></i>
                                    {{ detecting ? 'AI分析中...' : '智能识别' }}
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-purple-600">输入网址后点击智能识别，系统将自动尝试分析标题、日期和内容的提取规则。</p>
                        </div>

                        <!-- Manual/Edit Form -->
                        <div v-if="editingSource" class="border-t border-slate-100 pt-4 space-y-4 animate-fade-in">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-slate-700">网站名称</label>
                                    <input v-model="editingSource.name" type="text" class="w-full border border-slate-300 rounded-md p-2 text-sm">
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-slate-700">列表页 URL</label>
                                    <input v-model="editingSource.url" type="text" class="w-full border border-slate-300 rounded-md p-2 text-sm bg-slate-50" readonly>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-slate-700">列表项选择器 (CSS)</label>
                                    <input v-model="editingSource.selectors.item" type="text" class="w-full border border-slate-300 rounded-md p-2 text-sm font-mono text-blue-600">
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-slate-700">标题选择器</label>
                                    <input v-model="editingSource.selectors.title" type="text" class="w-full border border-slate-300 rounded-md p-2 text-sm font-mono text-blue-600">
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-slate-700">日期选择器</label>
                                    <input v-model="editingSource.selectors.date" type="text" class="w-full border border-slate-300 rounded-md p-2 text-sm font-mono text-blue-600">
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-slate-700">正文内容选择器</label>
                                    <input v-model="editingSource.selectors.content" type="text" class="w-full border border-slate-300 rounded-md p-2 text-sm font-mono text-blue-600">
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 pt-2">
                                <button @click="editingSource = null" class="px-4 py-2 text-sm text-slate-600 hover:text-slate-800">取消</button>
                                <button @click="saveSource" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存配置</button>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Sources List -->
                    <div class="space-y-3">
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">已配置源站 ({{ sources.length }})</h4>
                        <div v-for="(source, idx) in sources" :key="idx" class="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center group hover:border-blue-300 transition-colors">
                            <div>
                                <h5 class="font-medium text-slate-800">{{ source.name }}</h5>
                                <p class="text-xs text-slate-400 font-mono mt-1">{{ source.url }}</p>
                            </div>
                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="editSource(source)" class="text-slate-400 hover:text-blue-500 p-2" title="编辑">
                                    <i class="ph ph-pencil-simple text-lg"></i>
                                </button>
                                <button @click="deleteSource(source.url)" class="text-slate-400 hover:text-red-500 p-2" title="删除">
                                    <i class="ph ph-trash text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div v-else-if="currentView === 'settings'" key="settings" class="max-w-2xl mx-auto">
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xl font-bold mb-6 text-slate-800">系统设置</h3>
                        
                        <div class="space-y-6">
                            <!-- Basic Config -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">采集关键词 (用逗号分隔)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="ph ph-tag"></i></span>
                                    <input v-model="settings.keywords_str" type="text" placeholder="数字经济, 数据要素..." class="pl-10 w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 transition-all">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">排除关键词 (用逗号分隔)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="ph ph-prohibit"></i></span>
                                    <input v-model="settings.exclude_keywords_str" type="text" placeholder="解读, 评论..." class="pl-10 w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 transition-all">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">爬虫 Headless 模式</label>
                                    <select v-model="settings.crawler_headless" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500">
                                        <option :value="true">开启 (无头模式)</option>
                                        <option :value="false">关闭 (显示浏览器)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">爬虫超时 (ms)</label>
                                    <input v-model.number="settings.crawler_timeout" type="number" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">定时任务时间 (每日)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="ph ph-clock"></i></span>
                                    <input v-model="settings.schedule_time" type="time" class="pl-10 w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <hr class="border-slate-100 my-2">

                            <!-- API Keys -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">OpenAI API Key (用于AI总结与解析)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="ph ph-key"></i></span>
                                    <input v-model="settings.openai_api_key" type="password" placeholder="sk-..." class="pl-10 w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                </div>
                                <p class="mt-1 text-xs text-slate-400">密钥仅保存在本地 .env 文件中，不上传云端。</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Webhook URL (新政策通知)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="ph ph-paper-plane-right"></i></span>
                                    <input v-model="settings.webhook_url" type="text" placeholder="https://hook..." class="pl-10 w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">PushPlus Token (微信通知)</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="ph ph-wechat-logo"></i></span>
                                    <input v-model="settings.pushplus_token" type="text" placeholder="" class="pl-10 w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                </div>
                            </div>

                            <div class="pt-4 flex justify-end">
                                <button @click="saveSettings" class="bg-slate-900 text-white px-6 py-2.5 rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-2">
                                    <i class="ph ph-floppy-disk"></i> 保存设置
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Zone -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-red-200 mt-6">
                        <h3 class="text-lg font-bold mb-4 text-red-600 flex items-center gap-2">
                            <i class="ph-fill ph-warning-circle"></i> 危险区域
                        </h3>
                        <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-100">
                            <div>
                                <h4 class="font-medium text-red-900">清空政策库</h4>
                                <p class="text-xs text-red-600 mt-1">此操作将永久删除所有已采集的政策数据，无法恢复。请谨慎操作。</p>
                            </div>
                            <button @click="clearPolicies" class="bg-white border border-red-300 text-red-600 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                确认清空数据
                            </button>
                        </div>
                    </div>
                </div>
            </transition>
        </div>
    </main>
</div>

<script>
    const { createApp, ref, onMounted, computed, nextTick } = Vue;

    createApp({
        setup() {
            const currentView = ref('dashboard');
            const menuItems = [
                { id: 'dashboard', label: '仪表盘', icon: 'ph-squares-four' },
                { id: 'logs', label: '运行日志', icon: 'ph-terminal-window' },
                { id: 'policies', label: '政策库', icon: 'ph-files' },
                { id: 'sources', label: '源站管理', icon: 'ph-globe' },
                { id: 'settings', label: '系统设置', icon: 'ph-gear' }
            ];

            const stats = ref({});
            const policies = ref([]);
            const sources = ref([]);
            const settings = ref({});
            const logs = ref([]);
            const wsConnected = ref(false);
            const isCrawling = ref(false);
            
            // Search & Filter Refs
            const searchQuery = ref('');
            const searchSource = ref('');
            const searchStartDate = ref('');
            const searchEndDate = ref('');
            
            // Dashboard Data
            const latestPolicies = ref([]);

            // Pagination refs
            const currentPage = ref(1);
            const totalPages = ref(1);
            const totalItems = ref(0);
            
            // Log UI ref
            const logContainer = ref(null);

            // Sources Management
            const newSourceUrl = ref('');
            const detecting = ref(false);
            const editingSource = ref(null);

            const pageTitle = computed(() => {
                const item = menuItems.find(i => i.id === currentView.value);
                return item ? item.label : '仪表盘';
            });

            // WebSocket connection for logs
            let ws = null;
            const connectWebSocket = () => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/logs`;
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => { 
                    wsConnected.value = true;
                    console.log('WS Connected');
                    // Add initial status log
                    logs.value.push(">>> 系统已连接，等待任务...");
                };
                ws.onclose = () => { 
                    wsConnected.value = false; 
                    console.log('WS Closed, retrying...');
                    setTimeout(connectWebSocket, 3000); 
                };
                ws.onmessage = (event) => {
                    // Append log
                    logs.value.push(event.data);
                    
                    // Auto scroll to bottom
                    nextTick(() => {
                        if (logContainer.value) {
                            logContainer.value.scrollTop = logContainer.value.scrollHeight;
                        }
                    });
                    
                    if (event.data.includes("任务执行完成") || event.data.includes("任务异常退出")) {
                        isCrawling.value = false;
                        refreshData();
                    }
                };
            };

            const triggerCrawl = async () => {
                if (isCrawling.value) return;
                
                isCrawling.value = true;
                currentView.value = 'dashboard';
                logs.value = []; // Clear old logs
                logs.value.push('>>> 正在启动采集任务...');
                
                try {
                    await fetch('/api/crawl', { method: 'POST' });
                } catch (e) {
                    logs.value.push(`>>> 启动失败: ${e.message}`);
                    isCrawling.value = false;
                }
            };

            // Dashboard: Fetch latest policies
            const fetchLatestPolicies = async () => {
                try {
                    const res = await fetch(`/api/policies?page=1&page_size=8`);
                    const data = await res.json();
                    if (data.items) {
                        latestPolicies.value = data.items;
                    }
                } catch (e) { console.error(e); }
            };

            // Policy Library: Fetch with filters
            const fetchPolicies = async (page = 1) => {
                try {
                    const params = new URLSearchParams({
                        keyword: searchQuery.value,
                        source: searchSource.value,
                        start_date: searchStartDate.value,
                        end_date: searchEndDate.value,
                        page: page,
                        page_size: 20
                    });
                    const res = await fetch(`/api/policies?${params}`);
                    const data = await res.json();
                    
                    if (data.items) {
                        policies.value = data.items;
                        totalItems.value = data.total;
                        totalPages.value = data.total_pages;
                        currentPage.value = data.page;
                    }
                } catch (e) {
                    console.error("Fetch policies failed", e);
                }
            };

            const changePage = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages.value) {
                    fetchPolicies(newPage);
                }
            };
            
            const toggleExpand = (policy) => {
                policy.expanded = !policy.expanded;
            };

            const refreshData = async () => {
                try {
                    const s = await fetch('/api/stats');
                    stats.value = await s.json();
                    
                    fetchLatestPolicies();
                    await fetchPolicies();
                    
                    const src = await fetch('/api/sources');
                    sources.value = await src.json();
                    
                    const set = await fetch('/api/settings');
                    const settingsData = await set.json();
                    // Process arrays to strings for editing
                    settingsData.keywords_str = (settingsData.keywords || []).join(', ');
                    settingsData.exclude_keywords_str = (settingsData.exclude_keywords || []).join(', ');
                    settings.value = settingsData;
                } catch (e) {
                    console.error("Refresh data failed", e);
                }
            };
            
            const saveSettings = async () => {
                try {
                    // Convert strings back to arrays
                    const payload = { ...settings.value };
                    if (payload.keywords_str) {
                        payload.keywords = payload.keywords_str.split(/[,，]/).map(s => s.trim()).filter(Boolean);
                    }
                    if (payload.exclude_keywords_str) {
                        payload.exclude_keywords = payload.exclude_keywords_str.split(/[,，]/).map(s => s.trim()).filter(Boolean);
                    }
                    
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    alert('设置已保存');
                } catch (e) {
                    alert('保存设置失败');
                }
            };
            
            const clearPolicies = async () => {
                if(!confirm('⚠️ 极其危险操作！\n\n确定要清空所有数据库中的政策吗？此操作不可逆！')) return;
                
                // Double confirm
                const verify = prompt("请在该输入框中输入 'DELETE' 以确认删除：");
                if (verify !== 'DELETE') {
                    return;
                }
                
                try {
                    const res = await fetch('/api/policies', { method: 'DELETE' });
                    if (!res.ok) throw new Error(await res.text());
                    
                    alert('政策库数据已成功清空。');
                    refreshData();
                } catch (e) {
                    alert('清空失败: ' + e.message);
                }
            };
            
            const deletePolicy = async (policy) => {
                if(!confirm(`确定要删除政策 "${policy.title}" 吗？`)) return;
                
                try {
                    const res = await fetch(`/api/policies/${policy.id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error(await res.text());
                    
                    // Refresh current page
                    fetchPolicies(currentPage.value);
                } catch (e) {
                    alert('删除失败: ' + e.message);
                }
            };

            // Source Management Logic
            const isUpdateMode = ref(false);

            const autoDetectSource = async () => {
                if(!newSourceUrl.value) return;
                detecting.value = true;
                isUpdateMode.value = false;
                
                try {
                    const res = await fetch('/api/sources/autodetect', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url: newSourceUrl.value })
                    });
                    
                    if(!res.ok) throw new Error(await res.text());
                    
                    const data = await res.json();
                    editingSource.value = {
                        name: data.name,
                        url: newSourceUrl.value,
                        selectors: data.selectors
                    };
                } catch(e) {
                    alert('分析失败: ' + e.message);
                } finally {
                    detecting.value = false;
                }
            };

            const editSource = (source) => {
                editingSource.value = JSON.parse(JSON.stringify(source));
                isUpdateMode.value = true;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                editingSource.value = null;
                isUpdateMode.value = false;
                newSourceUrl.value = '';
            };
            
            const saveSource = async () => {
                if(!editingSource.value) return;
                try {
                    const method = isUpdateMode.value ? 'PUT' : 'POST';
                    const res = await fetch('/api/sources', {
                        method: method,
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(editingSource.value)
                    });
                    
                    if(!res.ok) throw new Error(await res.text());
                    
                    alert(isUpdateMode.value ? '更新成功' : '添加成功');
                    cancelEdit();
                    refreshData();
                } catch(e) {
                    alert('保存失败: ' + e.message);
                }
            };

            const deleteSource = async (url) => {
                if(!confirm('确定删除该源站吗？')) return;
                try {
                    await fetch(`/api/sources?url=${encodeURIComponent(url)}`, { method: 'DELETE' });
                    // Remove locally
                    sources.value = sources.value.filter(s => s.url !== url);
                } catch (e) {
                    alert('删除失败');
                }
            };

            onMounted(() => {
                refreshData();
                connectWebSocket();
            });

            return {
                currentView, menuItems, pageTitle,
                stats, policies, settings, sources,
                logs, wsConnected, isCrawling,
                searchQuery, searchSource, searchStartDate, searchEndDate,
                latestPolicies,
                logContainer,
                newSourceUrl, detecting, editingSource, isUpdateMode,
                triggerCrawl, fetchPolicies, saveSettings, fetchLatestPolicies, clearPolicies, deletePolicy,
                autoDetectSource, saveSource, deleteSource, editSource, cancelEdit,
                currentPage, totalPages, totalItems, changePage, toggleExpand
            };
        }
    }).mount('#app');
</script>
</body>
</html>
